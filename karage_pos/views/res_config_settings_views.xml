<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="res_config_settings_view_form" model="ir.ui.view">
        <field name="name">res.config.settings.view.form.inherit.karage.pos</field>
        <field name="model">res.config.settings</field>
        <field name="inherit_id" ref="base.res_config_settings_view_form"/>
        <field name="arch" type="xml">
            <xpath expr="//form" position="inside">
                <app string="Karage POS" name="karage_pos">
                    <!-- Default POS Info Banner -->
                    <div class="alert alert-warning mb-4" role="status">
                        <h5><i class="fa fa-info-circle"/> Default Karage POS Configuration</h5>
                        <p>
                            A default POS configuration (<strong>KARAGE - Default POS</strong>) was created during module installation.
                            This POS <strong>cannot be deleted</strong> as it is required for webhook integration.
                        </p>
                        <p class="mb-1">
                            <strong>Important:</strong> You must manually configure:
                        </p>
                        <ul class="mb-0">
                            <li><strong>Payment Method Journals</strong> - Go to Point of Sale &gt; Configuration &gt; Payment Methods</li>
                            <li><strong>Tax Settings</strong> - Go to Accounting &gt; Configuration &gt; Taxes</li>
                        </ul>
                    </div>

                    <!-- POS Configuration -->
                    <block title="POS Configuration" name="karage_pos_config">
                        <setting string="Default POS Receivable Account" name="default_pos_receivable_account_setting">
                            <field name="account_default_pos_receivable_account_id" options="{'no_create': True}"/>
                            <div class="text-muted">
                                Temporary receivable account used for POS customer payments.
                                This account is used to track payments before they are reconciled.
                            </div>
                        </setting>
                    </block>

                    <!-- Session Auto-Close Configuration -->
                    <block title="Session Auto-Close" name="karage_pos_session_auto_close">
                        <setting string="Auto-Close Idle Sessions" name="auto_close_sessions_setting">
                            <field name="auto_close_sessions"/>
                            <div class="text-muted">
                                Automatically close POS sessions after a period of inactivity.
                                Sessions with no new orders will be closed by a scheduled job (runs every 15 minutes).
                            </div>
                        </setting>
                        <setting string="Session Idle Timeout" name="session_idle_timeout_setting"
                                 invisible="not auto_close_sessions">
                            <div class="row mt-2">
                                <label class="col-3 col-form-label" for="session_idle_timeout_minutes"/>
                                <field name="session_idle_timeout_minutes" class="col-2"/>
                                <span class="col-7 text-muted mt-2">minutes (default: 60)</span>
                            </div>
                            <div class="text-muted">
                                Number of minutes of inactivity before a session is automatically closed.
                            </div>
                        </setting>
                    </block>

                    <!-- Order Processing -->
                    <block title="Order Processing" name="karage_pos_order_processing">
                        <setting string="External Order Source Code" name="external_order_source_code_setting">
                            <field name="external_order_source_code"/>
                            <div class="text-muted">
                                Identifier stored on orders received via webhook (for tracking).
                            </div>
                        </setting>
                        <setting string="Consistency Check Multiplier" name="consistency_check_multiplier_setting">
                            <field name="consistency_check_multiplier"/>
                            <div class="text-muted">
                                Multiplier for currency rounding tolerance in data consistency checks.
                            </div>
                        </setting>
                        <setting string="Valid Order Statuses" name="valid_order_statuses_setting">
                            <field name="valid_order_statuses"/>
                            <div class="text-muted">
                                Comma-separated list of valid OrderStatus values (e.g., "103,104").
                            </div>
                        </setting>
                    </block>

                    <!-- API & Logging -->
                    <block title="API &amp; Logging" name="karage_pos_api_logging">
                        <setting string="API Key Scopes" name="api_key_scopes_setting">
                            <field name="api_key_scopes"/>
                            <div class="text-muted">
                                Comma-separated list of API key scopes to try for authentication.
                            </div>
                        </setting>
                        <setting string="Log Key Truncation" name="log_key_truncation_length_setting">
                            <field name="log_key_truncation_length"/>
                            <div class="text-muted">
                                Number of characters to show when logging idempotency keys (for privacy).
                            </div>
                        </setting>
                    </block>

                    <!-- Idempotency Configuration -->
                    <block title="Idempotency Configuration" name="karage_pos_idempotency_config">
                        <setting string="Processing Timeout" name="idempotency_timeout_setting">
                            <field name="idempotency_processing_timeout"/>
                            <div class="text-muted">
                                Maximum time (in minutes) a request can stay in "processing" status before being considered stuck.
                            </div>
                        </setting>
                        <setting string="Record Retention" name="idempotency_retention_setting">
                            <field name="idempotency_retention_days"/>
                            <div class="text-muted">
                                Number of days to keep old idempotency records. Set to 0 to disable automatic cleanup.
                            </div>
                        </setting>
                    </block>

                    <!-- Bulk Sync Configuration -->
                    <block title="Bulk Sync Configuration" name="karage_pos_bulk_sync_config">
                        <setting string="Maximum Orders per Bulk Request" name="bulk_sync_max_orders_setting">
                            <field name="bulk_sync_max_orders"/>
                            <div class="text-muted">
                                Maximum number of orders allowed in a single bulk sync request.
                            </div>
                        </setting>
                    </block>

                    <!-- API Authentication Info -->
                    <block title="API Authentication Help" name="karage_pos_api_info">
                        <div class="alert alert-info">
                            <h4>Webhook API Authentication</h4>
                            <p>The webhook endpoint requires authentication using Odoo's built-in API key system.</p>

                            <h5 class="mt-3">How to Create an API Key:</h5>
                            <ol>
                                <li><strong>Navigate:</strong> Click your User Icon (top right) â†’ Preferences</li>
                                <li><strong>Account Security:</strong> Go to the "Account Security" tab</li>
                                <li><strong>Create Key:</strong> Click "New API Key" button</li>
                                <li><strong>Name the Key:</strong> Enter a clear description (e.g., "Karage POS Webhook Integration")
                                    <br/><small class="text-warning">This description is the only way to identify the key later!</small>
                                </li>
                                <li><strong>Set Duration:</strong> Choose key validity:
                                    <ul>
                                        <li>Temporary: 1 Day, 1 Week, 1 Month, 3 Months, 6 Months, 1 Year</li>
                                        <li><strong>Persistent Key</strong> (recommended for production - never expires)</li>
                                        <li>Custom Date</li>
                                    </ul>
                                </li>
                                <li><strong>Copy the Key:</strong> After creation, copy and securely store the API key
                                    <br/><small class="text-danger">You won't be able to see it again!</small>
                                </li>
                                <li><strong>Configure:</strong> Add the API key to your external Karage POS system</li>
                            </ol>

                            <h5 class="mt-3">Using the API Key:</h5>
                            <p>Include the key in webhook requests using the <code>X-API-KEY</code> header:</p>
                            <pre class="bg-light p-2 border">POST /api/v1/webhook/pos-order
X-API-KEY: your_api_key_here
Content-Type: application/json</pre>
                        </div>
                    </block>
                </app>
            </xpath>
        </field>
    </record>
</odoo>
