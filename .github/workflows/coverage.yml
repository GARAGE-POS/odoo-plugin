name: Code Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  coverage:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        odoo_version: ['18.0', '17.0']
        include:
          - odoo_version: '18.0'
            python_version: '3.11'
            postgres_version: '15'
          - odoo_version: '17.0'
            python_version: '3.11'
            postgres_version: '15'
      fail-fast: false

    name: Odoo ${{ matrix.odoo_version }}

    services:
      postgres:
        image: postgres:${{ matrix.postgres_version }}
        env:
          POSTGRES_PASSWORD: odoo
          POSTGRES_USER: odoo
          POSTGRES_DB: odoo_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python_version }}

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-odoo-${{ matrix.odoo_version }}-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-odoo-${{ matrix.odoo_version }}-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-dev \
          libxml2-dev \
          libxslt1-dev \
          libldap2-dev \
          libsasl2-dev \
          libjpeg-dev \
          libpq-dev \
          libffi-dev

    - name: Install Odoo and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install coverage
        # Install Odoo from source
        git clone --depth 1 --branch ${{ matrix.odoo_version }} https://github.com/odoo/odoo.git /tmp/odoo
        pip install -r /tmp/odoo/requirements.txt
        pip install -e /tmp/odoo

    - name: Transform module for Odoo 17
      if: matrix.odoo_version == '17.0'
      run: |
        # Update version in manifest
        sed -i 's/"version": "18\.0/"version": "17.0/' karage_pos/__manifest__.py
        # Convert list to tree in XML views (Odoo 17 syntax)
        sed -i 's/<list /<tree /g; s/<\/list>/<\/tree>/g' karage_pos/views/webhook_log_views.xml
        # Update version check in tests
        sed -i 's/startswith("18\.0")/startswith("17.0")/g' karage_pos/tests/test_models.py
        sed -i 's/start with 18\.0/start with 17.0/g' karage_pos/tests/test_models.py

    - name: Prepare Odoo configuration
      run: |
        mkdir -p ~/.local/share/Odoo
        cat > ~/.odoorc << EOF
        [options]
        addons_path = /tmp/odoo/addons,${GITHUB_WORKSPACE}
        db_host = localhost
        db_port = 5432
        db_user = odoo
        db_password = odoo
        EOF

    - name: Wait for PostgreSQL
      run: |
        until pg_isready -h localhost -p 5432 -U odoo; do
          echo "Waiting for PostgreSQL..."
          sleep 2
        done

    - name: Install karage-pos module
      run: |
        python -m odoo --init=karage_pos \
          --database=odoo_test \
          --db-filter=odoo_test \
          --stop-after-init \
          --log-level=warn

    - name: Update karage-pos module
      run: |
        python -m odoo --update=karage_pos \
          --database=odoo_test \
          --db-filter=odoo_test \
          --stop-after-init \
          --log-level=warn

    - name: Run tests with coverage
      run: |
        coverage run --source=karage_pos \
          --omit="*/tests/*,*/migrations/*,*/__pycache__/*" \
          -m odoo \
          --test-tags=/karage_pos,-http_case \
          --database=odoo_test \
          --db-filter=odoo_test \
          --stop-after-init \
          --log-level=test

    - name: Generate coverage reports
      run: |
        coverage report --show-missing
        coverage xml -o coverage.xml

    - name: SonarQube Scan
      uses: SonarSource/sonarqube-scan-action@v6
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
