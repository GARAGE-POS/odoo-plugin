name: Code Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  coverage:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: odoo
          POSTGRES_USER: odoo
          POSTGRES_DB: odoo_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-odoo-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-odoo-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-dev \
          libxml2-dev \
          libxslt1-dev \
          libldap2-dev \
          libsasl2-dev \
          libjpeg-dev \
          libpq-dev \
          libffi-dev

    - name: Install Odoo and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install coverage
        # Install Odoo 18 from source
        git clone --depth 1 --branch 18.0 https://github.com/odoo/odoo.git /tmp/odoo
        pip install -r /tmp/odoo/requirements.txt
        pip install -e /tmp/odoo

    - name: Prepare Odoo configuration
      run: |
        mkdir -p ~/.local/share/Odoo
        cat > ~/.odoorc << EOF
        [options]
        addons_path = /tmp/odoo/addons,${GITHUB_WORKSPACE}
        db_host = localhost
        db_port = 5432
        db_user = odoo
        db_password = odoo
        EOF

    - name: Wait for PostgreSQL
      run: |
        until pg_isready -h localhost -p 5432 -U odoo; do
          echo "Waiting for PostgreSQL..."
          sleep 2
        done

    - name: Install karage-pos module
      run: |
        python -m odoo --init=karage_pos \
          --database=odoo_test \
          --db-filter=odoo_test \
          --stop-after-init \
          --log-level=warn

    - name: Update karage-pos module
      run: |
        python -m odoo --update=karage_pos \
          --database=odoo_test \
          --db-filter=odoo_test \
          --stop-after-init \
          --log-level=warn

    - name: Run tests with coverage
      run: |
        coverage run --source=karage_pos \
          --omit="*/tests/*,*/migrations/*,*/__pycache__/*" \
          -m odoo \
          --test-tags=/karage_pos \
          --database=odoo_test \
          --db-filter=odoo_test \
          --stop-after-init \
          --log-level=test

    - name: Generate coverage reports
      run: |
        coverage report --show-missing
        coverage xml -o coverage.xml

    - name: SonarQube Scan
      uses: SonarSource/sonarqube-scan-action@v6
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
