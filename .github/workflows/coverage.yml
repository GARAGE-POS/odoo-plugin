name: Code Coverage

on:
  push:
    branches: [ fixes_to_integration ]
  pull_request:
    branches: [ fixes_to_integration ]

jobs:
  coverage:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: odoo
          POSTGRES_USER: odoo
          POSTGRES_DB: odoo_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-odoo-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-odoo-
          
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-dev \
          libxml2-dev \
          libxslt1-dev \
          libldap2-dev \
          libsasl2-dev \
          libjpeg-dev \
          libpq-dev \
          libffi-dev
          
    - name: Install Odoo and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install coverage
        # Install Odoo 17 from source
        git clone --depth 1 --branch 17.0 https://github.com/odoo/odoo.git /tmp/odoo
        pip install -r /tmp/odoo/requirements.txt
        pip install -e /tmp/odoo
        
    - name: Prepare Odoo configuration
      run: |
        mkdir -p ~/.local/share/Odoo
        cat > ~/.odoorc << EOF
        [options]
        addons_path = /tmp/odoo/addons,${GITHUB_WORKSPACE}
        db_host = localhost
        db_port = 5432
        db_user = odoo
        db_password = odoo
        EOF
        
    - name: Wait for PostgreSQL
      run: |
        until pg_isready -h localhost -p 5432 -U odoo; do
          echo "Waiting for PostgreSQL..."
          sleep 2
        done
        
    - name: Install karage-pos module
      run: |
        python -m odoo --init=karage_pos \
          --database=odoo_test_init \
          --db-filter=odoo_test_init \
          --stop-after-init \
          --log-level=warn
          
    - name: Run tests with coverage
      run: |
        coverage run --source=karage_pos \
          --omit="*/tests/*,*/migrations/*,*/__pycache__/*" \
          -m odoo --test-enable \
          --update=karage_pos \
          --database=odoo_test_coverage \
          --db-filter=odoo_test_coverage \
          --stop-after-init \
          --log-level=test
          
    - name: Generate coverage reports
      run: |
        coverage report --show-missing
        coverage xml -o coverage.xml
        coverage html -d htmlcov/
        
    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-karage-pos
        fail_ci_if_error: false
        verbose: true
        
    - name: Upload coverage HTML report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-html-report
        path: htmlcov/
        
    - name: Coverage Summary
      run: |
        echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        coverage report >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        
        # Get coverage percentage
        COVERAGE=$(coverage report --format=total)
        echo "Total Coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
        
        # Set coverage as output for badges
        echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT
        
    - name: Comment PR with coverage
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Read coverage report
          const { execSync } = require('child_process');
          const coverageOutput = execSync('coverage report', { encoding: 'utf8' });
          
          const comment = `## ðŸ“Š Code Coverage Report
          
          \`\`\`
          ${coverageOutput}
          \`\`\`
          
          ðŸ“ˆ [Full coverage report](https://codecov.io/gh/${{ github.repository }})
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });